const API_URL="http://localhost:3024/";let dataMusic=[],playlist=[];const favoriteList=localStorage.getItem("favorite")?JSON.parse(localStorage.getItem("favorite")):[],audio=new Audio,headerLogo=document.querySelector(".header__logo"),favoriteBtn=document.querySelector(".header__favorite-btn"),tracksCard=document.getElementsByClassName("track"),catalogContainer=document.querySelector(".catalog__container"),player=document.querySelector(".player"),pauseBtn=document.querySelector(".player__icon_pause"),stopBtn=document.querySelector(".player__icon_stop"),prewBtn=document.querySelector(".player__icon_prew"),nextBtn=document.querySelector(".player__icon_next"),likeBtn=document.querySelector(".player__icon_like"),muteBtn=document.querySelector(".player__icon_mute-on"),playerVolumeInput=document.querySelector(".player__volume-input"),playerProgressInput=document.querySelector(".player__progress-input"),playerTimePassed=document.querySelector(".player__time-passed"),playerTimeTotal=document.querySelector(".player__time-total"),search=document.querySelector(".search"),catalogAddBtn=document.createElement("button");catalogAddBtn.classList.add("catalog__btn-add"),catalogAddBtn.innerHTML='\n          <span>Увидеть все</span>\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">         \n              <path d="M8.59 16.59L13.17 12L8.59 7.41L10 6L16 12L10 18L8.59 16.59Z"/>           \n          </svg>\n';const pausePlayer=()=>{const e=document.querySelector(".track_active");audio.paused?(audio.play(),pauseBtn.classList.remove("player__icon_play"),e.classList.remove("track_pause")):(audio.pause(),pauseBtn.classList.add("player__icon_play"),e.classList.add("track_pause"))},playMusic=e=>{e.preventDefault();const t=e.currentTarget;if(t.classList.contains("track_active"))return void pausePlayer();let a=0;const r=t.dataset.idTrack;-1!==favoriteList.indexOf(r)?likeBtn.classList.add("player__icon_like_active"):likeBtn.classList.remove("player__icon_like_active");const c=playlist.find((e,t)=>(a=t,r===e.id));audio.src=`${API_URL}${c.mp3}`,audio.play(),pauseBtn.classList.remove("player__icon_play"),player.classList.add("player_active"),player.dataset.idTrack=r;const l=0===a?playlist.length-1:a-1,n=a+1===playlist.length?0:a+1;prewBtn.dataset.idTrack=playlist[l].id,nextBtn.dataset.idTrack=playlist[n].id,likeBtn.dataset.idTrack=r;for(let e=0;e<tracksCard.length;e++)r===tracksCard[e].dataset.idTrack?tracksCard[e].classList.add("track_active"):tracksCard[e].classList.remove("track_active")},addHendlerTrack=()=>{for(let e=0;e<tracksCard.length;e++)tracksCard[e].addEventListener("click",playMusic)};pauseBtn.addEventListener("click",pausePlayer),stopBtn.addEventListener("click",()=>{audio.src="",player.classList.remove("player_active"),document.querySelector(".track_active").classList.remove("track_active")});const createCard=e=>{const t=document.createElement("a");return t.href="#",t.className="catalog__item track",player.dataset.idTrack===e.id&&(t.classList.add("track_active"),audio.paused&&t.classList.add("track_pause")),t.dataset.idTrack=e.id,t.innerHTML=`\n          <div class="track__img-wrap">\n            <img class="track__poster" src="${API_URL}${e.poster}" alt="${e.artist} ${e.track}" width="180" height="180">\n          </div>\n          <div class="track__info">\n            <p class="track__title">${e.track}</p>\n            <p class="track__artitst">${e.artist}</p>\n          </div>\n  `,t},renderCatalog=e=>{playlist=[...e],catalogContainer.textContent="";const t=e.map(createCard);catalogContainer.append(...t),addHendlerTrack()},checkCount=(e=1)=>{catalogContainer.clientHeight>3*tracksCard[0].clientHeight?(tracksCard[tracksCard.length-e].style.display="none",checkCount(e+1)):1!==e&&catalogContainer.append(catalogAddBtn)},updateTime=()=>{const e=audio.duration,t=audio.currentTime,a=t/e*playerProgressInput.max;playerProgressInput.value=a||0;const r=Math.floor(t/60)||"0",c=Math.floor(t%60)||"0",l=Math.floor(e/60)||"0",n=Math.floor(e%60)||"0";playerTimePassed.textContent=`${r}:${c<10?"0"+c:c}`,playerTimeTotal.textContent=`${l}:${n<10?"0"+n:n}`},init=async()=>{audio.volume=localStorage.getItem("volume")||1,playerVolumeInput.value=100*audio.volume,dataMusic=await fetch(API_URL+"api/music").then(e=>e.json()),renderCatalog(dataMusic),checkCount(),catalogAddBtn.addEventListener("click",()=>{[...tracksCard].forEach(e=>{e.style.display="",catalogAddBtn.remove()})}),prewBtn.addEventListener("click",playMusic),nextBtn.addEventListener("click",playMusic),audio.addEventListener("timeupdate",updateTime),audio.addEventListener("ended",()=>{nextBtn.dispatchEvent(new Event("click",{bubbles:!0}))}),playerProgressInput.addEventListener("input",()=>{const e=playerProgressInput.value;audio.currentTime=e/playerProgressInput.max*audio.duration}),favoriteBtn.addEventListener("click",()=>{const e=dataMusic.filter(e=>favoriteList.includes(e.id));renderCatalog(e),checkCount()}),headerLogo.addEventListener("click",()=>{renderCatalog(dataMusic),checkCount()}),likeBtn.addEventListener("click",()=>{const e=favoriteList.indexOf(likeBtn.dataset.idTrack);-1===e?(favoriteList.push(likeBtn.dataset.idTrack),likeBtn.classList.add("player__icon_like_active")):(favoriteList.splice(e,1),likeBtn.classList.remove("player__icon_like_active")),localStorage.setItem("favorite",JSON.stringify(favoriteList))}),playerVolumeInput.addEventListener("input",()=>{const e=playerVolumeInput.value;audio.volume=e/100}),muteBtn.addEventListener("click",()=>{audio.volume?(localStorage.setItem("volume",audio.volume),audio.volume=0,playerVolumeInput.value=0,muteBtn.classList.add("player__icon_mute-off")):(audio.volume=localStorage.getItem("volume"),muteBtn.classList.remove("player__icon_mute-off"),playerVolumeInput.value=100*audio.volume)}),search.addEventListener("submit",async e=>{e.preventDefault(),playlist=await fetch(`${API_URL}api/music?search=${search.search.value}`).then(e=>e.json()),renderCatalog(playlist),checkCount()})};init();